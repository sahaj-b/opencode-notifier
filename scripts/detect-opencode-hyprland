#!/usr/bin/env bash

TERM_INITIAL_TITLE_REGEX='^(foot|kitty|Alacritty|Ghostty)$'

SESSION_TITLE="${1:-}"
set -u

if [ -n "$SESSION_TITLE" ]; then
  TITLE_PATTERN="OC | ${SESSION_TITLE:0:30}"
else
  TITLE_PATTERN="OC | *"
fi

if ! command -v hyprctl &>/dev/null; then
  exit 1
fi

ACTIVE_WINDOW=$(hyprctl activewindow -j 2>/dev/null)
if [ -z "$ACTIVE_WINDOW" ] || [ "$ACTIVE_WINDOW" = "null" ]; then
  exit 1
fi

INITIAL_TITLE=$(echo "$ACTIVE_WINDOW" | jq -r '.initialTitle // empty')
TITLE=$(echo "$ACTIVE_WINDOW" | jq -r '.title // empty')
TERM_PID=$(echo "$ACTIVE_WINDOW" | jq -r '.pid // empty')

if [[ ! "$INITIAL_TITLE" =~ $TERM_INITIAL_TITLE_REGEX ]]; then
  exit 1
fi

match_title() {
  local title="$1"
  if echo "$title" | grep -qiE "^OC \|"; then
    [ -z "$SESSION_TITLE" ] && return 0
    echo "$title" | grep -qiE "^$(echo "$TITLE_PATTERN" | sed 's/[][$()*?^|]/\\&/g')" && return 0
  fi
  return 1
}

# Check terminal title (non-tmux)
match_title "$TITLE" && exit 0

if ! command -v tmux &>/dev/null; then
  exit 1
fi

TMUX_CLIENTS=$(tmux list-clients -F '#{client_pid} #{client_session}' 2>/dev/null)

# check if the PID is of a tmux client & get active pane title
check_pid() {
  local pid=$1

  SESSION=$(awk -v pid="$pid" '$1 == pid {print $2}' <<<"$TMUX_CLIENTS")

  if [[ -n "$SESSION" ]]; then
    PANE_TITLE=$(tmux display-message -t "$SESSION" -p '#T')
    match_title "$PANE_TITLE" && exit 0
  fi
}

# walk process tree
find_tmux_client() {
  local pid=$1
  local is_root=$2

  if [[ "$is_root" != "true" ]]; then
    check_pid "$pid"
  fi

  local children=$(pgrep -P "$pid" 2>/dev/null)
  for child in $children; do
    find_tmux_client "$child" "false"
  done
}

find_tmux_client "$TERM_PID" "true"

exit 1
